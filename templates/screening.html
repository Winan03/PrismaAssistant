<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cribado Manual - PRISMA Assistant</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    
    .gradient-hero {
      background: linear-gradient(135deg, #1e3a8a 0%, #5b21b6 50%, #059669 100%);
    }
    
    .app-layout { display: flex; height: 100vh; flex-direction: column; }
    .main-content { flex: 1; display: flex; overflow: hidden; }
    .table-area { flex: 1; overflow-y: auto; padding: 24px; }
    
    .sidebar {
      width: 320px;
      min-width: 320px;
      background: white;
      border-left: 1px solid #e2e8f0;
      padding: 20px;
      overflow-y: auto;
      box-shadow: -4px 0 20px rgba(0,0,0,0.05);
    }

    .paper-card {
      background: white;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      margin-bottom: 20px;
      transition: all 0.3s ease;
      overflow: hidden;
    }
    .paper-card:hover { box-shadow: 0 8px 20px rgba(0,0,0,0.08); transform: translateY(-2px); }

    .status-bar { width: 6px; background: #cbd5e1; }
    .paper-card.included .status-bar { background: #10b981; }
    .paper-card.excluded .status-bar { background: #ef4444; opacity: 0.5; }
    .paper-card.excluded { opacity: 0.6; background: #f8fafc; }

    .ai-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1px;
      background: #e2e8f0;
      border-top: 1px solid #e2e8f0;
    }
    .ai-cell {
      background: #f8fafc;
      padding: 16px;
      font-size: 0.9rem;
      line-height: 1.6;
      color: #334155;
    }
    .ai-cell h5 {
      font-size: 0.75rem;
      text-transform: uppercase;
      font-weight: 700;
      color: #64748b;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .col-btn {
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 8px;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: 600;
      color: #475569;
      background: #fff;
      border: 1px solid #e2e8f0;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
      display: flex;
      align-items: center;
    }
    .col-btn:hover { background: #f1f5f9; border-color: #cbd5e1; transform: translateX(2px); }
    .col-btn.active { background: #eff6ff; border-color: #3b82f6; color: #1d4ed8; }
    .col-btn i { width: 20px; margin-right: 10px; }

    .relevance-badge {
      font-size: 0.85rem;
      font-weight: 700;
      padding: 6px 12px;
      border-radius: 8px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .relevance-high { background: #d1fae5; color: #065f46; border: 2px solid #10b981; }
    .relevance-medium { background: #fef3c7; color: #92400e; border: 2px solid #f59e0b; }
    .relevance-low { background: #fee2e2; color: #991b1b; border: 2px solid #ef4444; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .fade-in { animation: fadeIn 0.4s ease-out; }
    
    /* NUEVO: Indicador de carga */
    .loading-indicator {
      text-align: center;
      padding: 40px;
      color: #64748b;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-indigo-50">

<div class="app-layout">
  
  <!-- HEADER -->
  <div class="gradient-hero px-8 py-5 flex justify-between items-center text-white shadow-xl">
    <div class="flex items-center gap-4">
      <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
        <i class="fas fa-user-check text-xl"></i>
      </div>
      <div>
        <h1 class="text-2xl font-bold leading-none">Cribado Manual de Art√≠culos</h1>
        <p class="text-sm text-emerald-100 mt-1"><span id="total-articles-count">{{ articles|length }}</span> art√≠culos candidatos (>= 70% relevancia)</p>
      </div>
    </div>
    
    <div class="flex items-center gap-4">
      <div class="bg-black/20 px-5 py-3 rounded-xl text-sm font-medium backdrop-blur-sm border border-white/10">
        <span class="text-emerald-300 font-bold text-2xl" id="count-included">0</span>
        <span class="text-white/70 ml-2">Incluidos</span>
      </div>
      <button onclick="submitScreening()" class="bg-white text-emerald-800 px-8 py-3 rounded-xl text-sm font-bold hover:bg-emerald-50 transition shadow-xl flex items-center gap-2">
        <i class="fas fa-arrow-right"></i> Finalizar Revisi√≥n
      </button>
    </div>
  </div>

  <div class="main-content">
    
    <!-- √ÅREA DE ART√çCULOS -->
    <div class="table-area">
      <div class="max-w-6xl mx-auto" id="articles-list">
        <!-- Indicador de carga inicial -->
        <div class="loading-indicator" id="loading-indicator">
          <i class="fas fa-spinner fa-spin text-4xl text-indigo-500 mb-4"></i>
          <p class="text-lg font-semibold">Cargando art√≠culos...</p>
        </div>
      </div>
    </div>

    <!-- SIDEBAR -->
    <div class="sidebar">
      
      <div class="mb-8">
        <h3 class="text-xs font-extrabold text-slate-400 uppercase tracking-wider mb-4">Herramientas Globales</h3>
        <button onclick="translateAllAbstracts()" id="btn-translate-all" class="col-btn">
          <i class="fas fa-language text-blue-500"></i> Traducir Todos los Abstracts
        </button>
      </div>

      <div class="mb-8">
        <h3 class="text-xs font-extrabold text-slate-400 uppercase tracking-wider mb-4">Agregar Columnas IA</h3>
        
        <!-- Columnas B√°sicas -->
        <button onclick="addColumn('summary')" id="btn-summary" class="col-btn">
          <i class="fas fa-align-left text-blue-500"></i> Resumen (Espa√±ol)
        </button>
        <button onclick="addColumn('methodology')" id="btn-methodology" class="col-btn">
          <i class="fas fa-microscope text-purple-500"></i> Metodolog√≠a
        </button>
        <button onclick="addColumn('population')" id="btn-population" class="col-btn">
          <i class="fas fa-users text-orange-500"></i> Poblaci√≥n / Datasets
        </button>
        
        <!-- Nuevas Columnas Avanzadas -->
        <button onclick="addColumn('study_design')" id="btn-study_design" class="col-btn">
          <i class="fas fa-project-diagram text-cyan-600"></i> Dise√±o del Estudio
        </button>
        <button onclick="addColumn('objectives')" id="btn-objectives" class="col-btn">
          <i class="fas fa-bullseye text-emerald-600"></i> Objetivos
        </button>
        <button onclick="addColumn('independent_variables')" id="btn-independent_variables" class="col-btn">
          <i class="fas fa-sliders-h text-indigo-500"></i> Variables Indep.
        </button>
        <button onclick="addColumn('dependent_variables')" id="btn-dependent_variables" class="col-btn">
          <i class="fas fa-chart-line text-pink-500"></i> Variables Dep.
        </button>

        <button onclick="addColumn('key_findings')" id="btn-key_findings" class="col-btn">
          <i class="fas fa-lightbulb text-yellow-500"></i> Hallazgos Clave
        </button>
        <button onclick="addColumn('limitations')" id="btn-limitations" class="col-btn">
          <i class="fas fa-exclamation-triangle text-red-500"></i> Limitaciones
        </button>
      </div>

      <div class="mt-auto bg-slate-50 p-4 rounded-xl border border-slate-100">
        <div class="flex items-center justify-between mb-2">
          <span class="text-xs font-bold text-slate-600">Agente IA</span>
          <div class="w-2.5 h-2.5 rounded-full bg-slate-300" id="agent-status-dot"></div>
        </div>
        <p class="text-xs text-slate-400 truncate" id="queue-status">Inactivo</p>
        <div class="w-full bg-slate-200 rounded-full h-1.5 mt-2">
          <div class="bg-emerald-500 h-full transition-all" style="width: 0%" id="queue-progress"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
  // ============================================================
  // üî• CARGA DE DATOS CON VALIDACI√ìN ROBUSTA
  // ============================================================
  let articlesData = [];
  
  // Funci√≥n para escapar HTML y prevenir XSS
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Intentar cargar art√≠culos con m√∫ltiples estrategias
  function loadArticles() {
    try {
      // Estrategia 1: JSON directo desde Jinja2
      const rawData = {{ articles | tojson | safe }};
      
      if (!rawData || !Array.isArray(rawData)) {
        throw new Error("Datos no v√°lidos desde el servidor");
      }
      
      articlesData = rawData;
      console.log("‚úÖ Art√≠culos cargados correctamente:", articlesData.length);
      
      // Validar que cada art√≠culo tenga las propiedades m√≠nimas
      articlesData = articlesData.filter(art => {
        if (!art || typeof art !== 'object') return false;
        if (!art.title || art.title.length < 5) return false;
        return true;
      });
      
      console.log("‚úÖ Art√≠culos v√°lidos despu√©s de filtrado:", articlesData.length);
      
      if (articlesData.length === 0) {
        throw new Error("No hay art√≠culos v√°lidos para mostrar");
      }
      
      return true;
      
    } catch (e) {
      console.error("‚ùå Error cr√≠tico cargando datos:", e);
      
      // Mostrar error en la UI
      const container = document.getElementById('articles-list');
      container.innerHTML = `
        <div class="bg-red-50 border-2 border-red-200 rounded-xl p-8 text-center">
          <i class="fas fa-exclamation-circle text-red-500 text-5xl mb-4"></i>
          <h2 class="text-xl font-bold text-red-700 mb-2">Error al Cargar Art√≠culos</h2>
          <p class="text-red-600 mb-4">${escapeHtml(e.message)}</p>
          <button onclick="location.reload()" class="bg-red-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-600">
            <i class="fas fa-redo mr-2"></i> Recargar P√°gina
          </button>
        </div>
      `;
      
      return false;
    }
  }

  // ============================================================
  // üé® RENDERIZADO DE ART√çCULOS
  // ============================================================
  function renderArticles() {
    const container = document.getElementById('articles-list');
    const loadingIndicator = document.getElementById('loading-indicator');
    
    if (!articlesData || articlesData.length === 0) {
      container.innerHTML = `
        <div class="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-8 text-center">
          <i class="fas fa-inbox text-yellow-500 text-5xl mb-4"></i>
          <h2 class="text-xl font-bold text-yellow-700">No hay art√≠culos para revisar</h2>
          <p class="text-yellow-600 mt-2">Intenta ajustar los filtros de b√∫squeda</p>
        </div>
      `;
      return;
    }
    
    // Remover indicador de carga
    if (loadingIndicator) {
      loadingIndicator.remove();
    }
    
    // Renderizar cada art√≠culo
    articlesData.forEach((article, index) => {
      const card = createArticleCard(article, index);
      container.appendChild(card);
    });
    
    console.log(`‚úÖ Renderizados ${articlesData.length} art√≠culos en el DOM`);
  }

  function createArticleCard(article, index) {
    const card = document.createElement('div');
    card.className = 'paper-card flex fade-in';
    card.id = `card-${index}`;
    card.style.animationDelay = `${Math.min(index * 0.05, 2)}s`; // Max 2s delay
    
    // Calcular relevancia
    const percent = Math.round((article.similarity || 0) * 100);
    let relevanceClass = 'relevance-low';
    let relevanceIcon = '‚ùå';
    if (percent >= 85) { 
      relevanceClass = 'relevance-high'; 
      relevanceIcon = '‚úÖ'; 
    } else if (percent >= 70) { 
      relevanceClass = 'relevance-medium'; 
      relevanceIcon = '‚ö†Ô∏è'; 
    }
    
    // Sanitizar datos
    const title = escapeHtml(article.title || 'Sin t√≠tulo');
    const year = escapeHtml(String(article.year || 'N/D'));
    const authors = Array.isArray(article.authors) 
      ? article.authors.slice(0, 2).map(a => escapeHtml(a)).join(', ')
      : 'Autores no disponibles';
    const journal = article.journal ? escapeHtml(article.journal) : '';
    const abstract = escapeHtml(article.abstract || 'Abstract no disponible');
    
    card.innerHTML = `
      <div class="status-bar"></div>
      <div class="w-full">
        <div class="p-6">
          <div class="flex justify-between items-start gap-6">
            <div class="flex-1">
              <h3 class="text-xl font-bold text-slate-800 mb-3 leading-tight hover:text-indigo-600 transition cursor-pointer">
                ${title}
              </h3>
              <div class="flex flex-wrap gap-3 text-sm text-slate-500 mb-4">
                <span class="bg-slate-100 px-3 py-1 rounded-lg font-semibold text-slate-700">
                  <i class="fas fa-calendar mr-1"></i> ${year}
                </span>
                <span><i class="fas fa-users mr-1"></i> ${authors}</span>
                ${journal ? `<span class="italic text-xs">${journal}</span>` : ''}
                <span class="relevance-badge ${relevanceClass}">
                  ${relevanceIcon} ${percent}% Relevancia
                </span>
              </div>

              <details class="group">
                <summary class="text-sm text-indigo-600 cursor-pointer hover:underline font-semibold list-none flex items-center gap-2 w-fit select-none">
                  <i class="fas fa-chevron-right text-xs transition-transform group-open:rotate-90"></i>
                  Ver Abstract Original
                </summary>
                <div class="mt-3 text-slate-600 leading-relaxed text-sm pl-4 border-l-4 border-slate-200">
                  ${abstract}
                  <div id="translation-box-${index}" class="hidden"></div>
                </div>
              </details>
            </div>

            <div class="flex flex-col gap-3 min-w-[140px]">
              <button onclick="setDecision(${index}, 'included')" 
                      class="px-5 py-3 rounded-xl border-2 border-emerald-200 text-emerald-700 text-sm font-bold hover:bg-emerald-50 transition flex items-center justify-center gap-2 bg-white shadow-md hover:shadow-xl">
                <i class="fas fa-check"></i> Incluir
              </button>
              <button onclick="setDecision(${index}, 'excluded')" 
                      class="px-5 py-3 rounded-xl border-2 border-red-200 text-red-700 text-sm font-bold hover:bg-red-50 transition flex items-center justify-center gap-2 bg-white shadow-md hover:shadow-xl">
                <i class="fas fa-times"></i> Excluir
              </button>
            </div>
          </div>
        </div>
        <div id="ai-container-${index}" class="ai-container hidden"></div>
      </div>
    `;
    
    return card;
  }

  // ============================================================
  // üöÄ INICIALIZACI√ìN
  // ============================================================
  let activeColumns = [];
  let taskQueue = [];
  let isProcessing = false;
  let totalTasks = 0;
  let completedTasks = 0;
  let decisions = new Set();

  // Inicializar cuando el DOM est√© listo
  document.addEventListener('DOMContentLoaded', function() {
    console.log("üöÄ Inicializando aplicaci√≥n...");
    
    const success = loadArticles();
    if (success) {
      renderArticles();
    }
  });

  // ============================================================
  // AGREGAR COLUMNA
  // ============================================================
  window.addColumn = function(colName) {
    if (activeColumns.includes(colName)) {
      console.log(`‚ö†Ô∏è Columna '${colName}' ya est√° activa`);
      return;
    }
    
    activeColumns.push(colName);

    const btn = document.getElementById(`btn-${colName}`);
    if(btn) {
      btn.classList.add('active');
      btn.onclick = null;
      btn.innerHTML += ' <i class="fas fa-check ml-auto"></i>';
    }

    articlesData.forEach((_, index) => {
      const container = document.getElementById(`ai-container-${index}`);
      if(!container) return;

      container.classList.remove('hidden');
      
      const meta = getColumnMeta(colName);
      const cellId = `cell-${index}-${colName}`;
      const div = document.createElement('div');
      div.className = 'ai-cell fade-in';
      div.id = cellId;
      div.innerHTML = `
        <h5><i class="${meta.icon} ${meta.color}"></i> ${meta.title}</h5>
        <div class="text-slate-400 text-xs animate-pulse flex items-center gap-2">
          <i class="fas fa-circle-notch fa-spin"></i> En cola...
        </div>
      `;
      container.appendChild(div);
      
      taskQueue.push({ type: 'column', articleId: index, columnName: colName, cellId: cellId });
      totalTasks++;
    });

    processQueue();
  };

  function getColumnMeta(col) {
    const map = {
      'methodology': { title: 'Metodolog√≠a', icon: 'fas fa-microscope', color: 'text-purple-500' },
      'population': { title: 'Poblaci√≥n', icon: 'fas fa-users', color: 'text-orange-500' },
      'key_findings': { title: 'Hallazgos', icon: 'fas fa-lightbulb', color: 'text-yellow-500' },
      'limitations': { title: 'Limitaciones', icon: 'fas fa-exclamation-triangle', color: 'text-red-500' },
      'summary': { title: 'Resumen', icon: 'fas fa-align-left', color: 'text-blue-500' },
      // Nuevas columnas
      'study_design': { title: 'Dise√±o', icon: 'fas fa-project-diagram', color: 'text-cyan-600' },
      'objectives': { title: 'Objetivos', icon: 'fas fa-bullseye', color: 'text-emerald-600' },
      'independent_variables': { title: 'Vars. Indep.', icon: 'fas fa-sliders-h', color: 'text-indigo-500' },
      'dependent_variables': { title: 'Vars. Dep.', icon: 'fas fa-chart-line', color: 'text-pink-500' }
    };
    return map[col] || { title: col, icon: 'fas fa-robot', color: 'text-gray-500' };
  }

  // ============================================================
  // TRADUCCI√ìN
  // ============================================================
  window.translateAllAbstracts = function() {
    const btn = document.getElementById('btn-translate-all');
    btn.classList.add('active');
    btn.innerHTML = '<i class="fas fa-spinner fa-spin text-blue-500 mr-2"></i> Procesando...';
    
    articlesData.forEach((art, idx) => {
      if(art.abstract && art.abstract.length > 20) {
        taskQueue.push({ type: 'translate', articleId: idx });
        totalTasks++;
      }
    });
    processQueue();
  };

  // ============================================================
  // PROCESADOR DE COLA
  // ============================================================
  async function processQueue() {
    if (isProcessing || taskQueue.length === 0) {
      updateQueueUI();
      return;
    }

    isProcessing = true;
    const task = taskQueue.shift();
    updateQueueUI("active");

    try {
      if (task.type === 'column') await fetchAIColumn(task);
      if (task.type === 'translate') await fetchTranslation(task);
    } catch (e) {
      console.error("‚ùå Error en tarea:", e);
    }

    completedTasks++;
    setTimeout(() => {
      isProcessing = false;
      processQueue();
    }, 800); // Reducido de 1500ms a 800ms
  }

  function updateQueueUI(state = "idle") {
    const dot = document.getElementById('agent-status-dot');
    const text = document.getElementById('queue-status');
    const bar = document.getElementById('queue-progress');
    
    if (taskQueue.length === 0 && !isProcessing) {
      dot.className = "w-2.5 h-2.5 rounded-full bg-slate-300";
      text.innerText = "Inactivo";
      bar.style.width = "100%";
      return;
    }

    dot.className = "w-2.5 h-2.5 rounded-full bg-emerald-500 animate-pulse";
    text.innerText = `Procesando (${taskQueue.length} pendientes)`;
    
    const percent = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;
    bar.style.width = `${percent}%`;
  }

  // ============================================================
  // LLAMADAS AJAX
  // ============================================================
  async function fetchAIColumn(task) {
    const cell = document.getElementById(task.cellId);
    if(!cell) return;
    
    // Indicador de carga
    cell.querySelector('div').innerHTML = `<div class="flex items-center gap-2 text-indigo-600"><i class="fas fa-circle-notch fa-spin"></i> Analizando...</div>`;

    try {
      const response = await fetch('/generate_column', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          article: articlesData[task.articleId], 
          column_name: task.columnName,
          question: "{{ question }}"
        })
      });

      if(response.ok) {
        const data = await response.json();
        const contentDiv = cell.querySelector('div');
        
        // ‚úÖ CORRECCI√ìN VISUAL:
        // 1. Usamos una clase que permita saltos de l√≠nea y buen espaciado
        contentDiv.className = "text-slate-700 mt-2 text-sm leading-relaxed prose prose-sm max-w-none";
        
        // 2. Inyectamos como HTML real. El backend ya env√≠a <b> y <br>.
        contentDiv.innerHTML = data.value; 
        
        // Guardar en datos locales
        if(!articlesData[task.articleId].ai_data) articlesData[task.articleId].ai_data = {};
        articlesData[task.articleId].ai_data[task.columnName] = data.value;
      } else {
        throw new Error(`HTTP ${response.status}`);
      }
    } catch(e) {
      console.error("‚ùå Error generando columna:", e);
      // Mensaje de error amigable
      cell.querySelector('div').innerHTML = `<div class="text-amber-600 text-xs bg-amber-50 p-2 rounded border border-amber-200 mt-1"><i class="fas fa-exclamation-triangle"></i> No se pudo analizar. Reintentando...</div>`;
      
      // Opcional: Reintentar autom√°ticamente despu√©s de 3 segundos
      setTimeout(() => {
          // Solo reintentar si sigue mostrando error (para evitar bucles infinitos si es error fatal)
          if(cell.querySelector('div').innerText.includes("No se pudo analizar")) {
              fetchAIColumn(task); 
          }
      }, 3000);
    }
  }

  async function fetchTranslation(task) {
    const box = document.getElementById(`translation-box-${task.articleId}`);
    if(!box) return;
    
    box.classList.remove('hidden');
    box.innerHTML = `<div class="mt-3 p-3 bg-blue-50 rounded-lg text-blue-500 text-xs">
      <i class="fas fa-spinner fa-spin"></i> Traduciendo...
    </div>`;

    try {
      const response = await fetch('/translate_abstract', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          article_id: task.articleId, 
          abstract: articlesData[task.articleId].abstract 
        })
      });

      if(response.ok) {
        const data = await response.json();
        box.className = "mt-3 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500";
        box.innerHTML = `<strong class="text-blue-700">[ES]</strong> <span class="text-slate-700">${escapeHtml(data.translation)}</span>`;
        articlesData[task.articleId].translation = data.translation;
      } else {
        throw new Error(`HTTP ${response.status}`);
      }
    } catch(e) { 
      console.error("‚ùå Error traduciendo:", e);
      box.innerHTML = `<span class="text-red-400">Error de traducci√≥n</span>`;
    }
  }

  // ============================================================
  // DECISIONES
  // ============================================================
  window.setDecision = function(id, decision) {
    const card = document.getElementById(`card-${id}`);
    if (!card) return;
    
    card.classList.remove('included', 'excluded');
    
    if (decision === 'included') {
      card.classList.add('included');
      decisions.add(id);
    } else {
      card.classList.add('excluded');
      decisions.delete(id);
    }
    document.getElementById('count-included').innerText = decisions.size;
  };

  // ============================================================
  // FINALIZAR
  // ============================================================
  window.submitScreening = async function() {
    if (decisions.size === 0) {
      if(!confirm("No has incluido ning√∫n art√≠culo. ¬øContinuar de todas formas?")) return;
    }
    
    const btn = document.querySelector('button[onclick="submitScreening()"]');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando decisiones...';

    let payload = {
      sessionId: "{{ session_id }}",
      question: "{{ question }}",
      articles: {}
    };

    articlesData.forEach((art, idx) => {
      let status = 'pending';
      const card = document.getElementById(`card-${idx}`);
      if (card && card.classList.contains('included')) status = 'included';
      if (card && card.classList.contains('excluded')) status = 'excluded';

      payload.articles[idx] = {
        status: status,
        data: art,
        aiGeneratedFields: art.ai_data || {},
        translation: art.translation || ""
      };
    });

    try {
      const res = await fetch('/submit_screening', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      
      if(res.ok) {
        const html = await res.text();
        document.open(); 
        document.write(html); 
        document.close();
      } else {
        throw new Error(`Error del servidor: ${res.status}`);
      }
    } catch(e) {
      alert(`Error de conexi√≥n: ${e.message}`);
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-arrow-right"></i> Finalizar Revisi√≥n';
    }
  };
</script>

</body>
</html>