<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cribado Manual - PRISMA Assistant</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    
    .gradient-hero {
      background: linear-gradient(135deg, #1e3a8a 0%, #5b21b6 50%, #059669 100%);
    }
    
    /* Layout con Sidebar Fijo */
    .app-layout { display: flex; height: 100vh; flex-direction: column; }
    .main-content { flex: 1; display: flex; overflow: hidden; }
    .table-area { flex: 1; overflow-y: auto; padding: 24px; }
    
    .sidebar {
      width: 320px;
      min-width: 320px;
      background: white;
      border-left: 1px solid #e2e8f0;
      padding: 20px;
      overflow-y: auto;
      box-shadow: -4px 0 20px rgba(0,0,0,0.05);
    }

    /* Tarjetas de Artículos */
    .paper-card {
      background: white;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      margin-bottom: 20px;
      transition: all 0.3s ease;
      overflow: hidden;
    }
    .paper-card:hover { box-shadow: 0 8px 20px rgba(0,0,0,0.08); transform: translateY(-2px); }

    /* Barra de Estado Lateral */
    .status-bar { width: 6px; background: #cbd5e1; }
    .paper-card.included .status-bar { background: #10b981; }
    .paper-card.excluded .status-bar { background: #ef4444; opacity: 0.5; }
    .paper-card.excluded { opacity: 0.6; background: #f8fafc; }

    /* Columnas IA */
    .ai-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1px;
      background: #e2e8f0;
      border-top: 1px solid #e2e8f0;
    }
    .ai-cell {
      background: #f8fafc;
      padding: 16px;
      font-size: 0.9rem;
      line-height: 1.6;
      color: #334155;
    }
    .ai-cell h5 {
      font-size: 0.75rem;
      text-transform: uppercase;
      font-weight: 700;
      color: #64748b;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Botones Sidebar */
    .col-btn {
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 8px;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: 600;
      color: #475569;
      background: #fff;
      border: 1px solid #e2e8f0;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
      display: flex;
      align-items: center;
    }
    .col-btn:hover { background: #f1f5f9; border-color: #cbd5e1; transform: translateX(2px); }
    .col-btn.active { background: #eff6ff; border-color: #3b82f6; color: #1d4ed8; }
    .col-btn i { width: 20px; margin-right: 10px; }

    /* Relevancia con Colores */
    .relevance-badge {
      font-size: 0.85rem;
      font-weight: 700;
      padding: 6px 12px;
      border-radius: 8px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .relevance-high { background: #d1fae5; color: #065f46; border: 2px solid #10b981; }
    .relevance-medium { background: #fef3c7; color: #92400e; border: 2px solid #f59e0b; }
    .relevance-low { background: #fee2e2; color: #991b1b; border: 2px solid #ef4444; }

    /* Animaciones */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .fade-in { animation: fadeIn 0.4s ease-out; }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-indigo-50">

<div class="app-layout">
  
  <!-- HEADER -->
  <div class="gradient-hero px-8 py-5 flex justify-between items-center text-white shadow-xl">
    <div class="flex items-center gap-4">
      <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
        <i class="fas fa-user-check text-xl"></i>
      </div>
      <div>
        <h1 class="text-2xl font-bold leading-none">Cribado Manual de Artículos</h1>
        <p class="text-sm text-emerald-100 mt-1">{{ articles|length }} artículos candidatos (>= 70% relevancia)</p>
      </div>
    </div>
    
    <div class="flex items-center gap-4">
      <div class="bg-black/20 px-5 py-3 rounded-xl text-sm font-medium backdrop-blur-sm border border-white/10">
        <span class="text-emerald-300 font-bold text-2xl" id="count-included">0</span>
        <span class="text-white/70 ml-2">Incluidos</span>
      </div>
      <button onclick="submitScreening()" class="bg-white text-emerald-800 px-8 py-3 rounded-xl text-sm font-bold hover:bg-emerald-50 transition shadow-xl flex items-center gap-2">
        <i class="fas fa-arrow-right"></i> Finalizar Revisión
      </button>
    </div>
  </div>

  <div class="main-content">
    
    <!-- ÁREA DE ARTÍCULOS -->
    <div class="table-area">
      <div class="max-w-6xl mx-auto" id="articles-list">
        <!-- Artículos se generan dinámicamente -->
      </div>
    </div>

    <!-- SIDEBAR -->
    <div class="sidebar">
      
      <div class="mb-8">
        <h3 class="text-xs font-extrabold text-slate-400 uppercase tracking-wider mb-4">Herramientas Globales</h3>
        <button onclick="translateAllAbstracts()" id="btn-translate-all" class="col-btn">
          <i class="fas fa-language text-blue-500"></i> Traducir Todos los Abstracts
        </button>
      </div>

      <div class="mb-8">
        <h3 class="text-xs font-extrabold text-slate-400 uppercase tracking-wider mb-4">Agregar Columnas IA</h3>
        <button onclick="addColumn('summary')" id="btn-summary" class="col-btn">
          <i class="fas fa-align-left text-blue-500"></i> Resumen (Español)
        </button>
        <button onclick="addColumn('methodology')" id="btn-methodology" class="col-btn">
          <i class="fas fa-microscope text-purple-500"></i> Metodología
        </button>
        <button onclick="addColumn('population')" id="btn-population" class="col-btn">
          <i class="fas fa-users text-orange-500"></i> Población
        </button>
        <button onclick="addColumn('key_findings')" id="btn-key_findings" class="col-btn">
          <i class="fas fa-lightbulb text-yellow-500"></i> Hallazgos Clave
        </button>
        <button onclick="addColumn('limitations')" id="btn-limitations" class="col-btn">
          <i class="fas fa-exclamation-triangle text-red-500"></i> Limitaciones
        </button>
      </div>

      <div class="mt-auto bg-slate-50 p-4 rounded-xl border border-slate-100">
        <div class="flex items-center justify-between mb-2">
          <span class="text-xs font-bold text-slate-600">Agente IA</span>
          <div class="w-2.5 h-2.5 rounded-full bg-slate-300" id="agent-status-dot"></div>
        </div>
        <p class="text-xs text-slate-400 truncate" id="queue-status">Inactivo</p>
        <div class="w-full bg-slate-200 rounded-full h-1.5 mt-2">
          <div class="bg-emerald-500 h-full transition-all" style="width: 0%" id="queue-progress"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
  let articlesData = [];
  try {
    articlesData = {{ articles | tojson | safe }};
    console.log("✅ Artículos cargados:", articlesData.length);
  } catch (e) {
    console.error("❌ Error cargando datos:", e);
    alert("Error crítico al cargar artículos");
  }

  let activeColumns = [];
  let taskQueue = [];
  let isProcessing = false;
  let totalTasks = 0;
  let completedTasks = 0;
  let decisions = new Set();

  // RENDERIZADO INICIAL
  const container = document.getElementById('articles-list');
  articlesData.forEach((article, index) => {
    const card = document.createElement('div');
    card.className = 'paper-card flex fade-in';
    card.id = `card-${index}`;
    card.style.animationDelay = `${index * 0.05}s`;
    
    const percent = Math.round((article.similarity || 0) * 100);
    let relevanceClass = 'relevance-low';
    let relevanceIcon = '❌';
    if (percent >= 85) { relevanceClass = 'relevance-high'; relevanceIcon = '✅'; }
    else if (percent >= 70) { relevanceClass = 'relevance-medium'; relevanceIcon = '⚠️'; }
    
    card.innerHTML = `
      <div class="status-bar"></div>
      <div class="w-full">
        <div class="p-6">
          <div class="flex justify-between items-start gap-6">
            <div class="flex-1">
              <h3 class="text-xl font-bold text-slate-800 mb-3 leading-tight hover:text-indigo-600 transition cursor-pointer">
                ${article.title}
              </h3>
              <div class="flex flex-wrap gap-3 text-sm text-slate-500 mb-4">
                <span class="bg-slate-100 px-3 py-1 rounded-lg font-semibold text-slate-700">
                  <i class="fas fa-calendar mr-1"></i> ${article.year || 'N/D'}
                </span>
                <span><i class="fas fa-users mr-1"></i> ${(article.authors || []).slice(0,2).join(', ')}</span>
                ${article.journal ? `<span class="italic text-xs">${article.journal}</span>` : ''}
                <span class="relevance-badge ${relevanceClass}">
                  ${relevanceIcon} ${percent}% Relevancia
                </span>
              </div>

              <details class="group">
                <summary class="text-sm text-indigo-600 cursor-pointer hover:underline font-semibold list-none flex items-center gap-2 w-fit select-none">
                  <i class="fas fa-chevron-right text-xs transition-transform group-open:rotate-90"></i>
                  Ver Abstract Original
                </summary>
                <div class="mt-3 text-slate-600 leading-relaxed text-sm pl-4 border-l-4 border-slate-200">
                  ${article.abstract || 'No disponible'}
                  <div id="translation-box-${index}" class="hidden"></div>
                </div>
              </details>
            </div>

            <div class="flex flex-col gap-3 min-w-[140px]">
              <button onclick="setDecision(${index}, 'included')" 
                      class="px-5 py-3 rounded-xl border-2 border-emerald-200 text-emerald-700 text-sm font-bold hover:bg-emerald-50 transition flex items-center justify-center gap-2 bg-white shadow-md hover:shadow-xl">
                <i class="fas fa-check"></i> Incluir
              </button>
              <button onclick="setDecision(${index}, 'excluded')" 
                      class="px-5 py-3 rounded-xl border-2 border-red-200 text-red-700 text-sm font-bold hover:bg-red-50 transition flex items-center justify-center gap-2 bg-white shadow-md hover:shadow-xl">
                <i class="fas fa-times"></i> Excluir
              </button>
            </div>
          </div>
        </div>
        <div id="ai-container-${index}" class="ai-container hidden"></div>
      </div>
    `;
    container.appendChild(card);
  });

  // AGREGAR COLUMNA
  window.addColumn = function(colName) {
    if (activeColumns.includes(colName)) return;
    activeColumns.push(colName);

    const btn = document.getElementById(`btn-${colName}`);
    if(btn) {
      btn.classList.add('active');
      btn.onclick = null;
      btn.innerHTML += ' <i class="fas fa-check ml-auto"></i>';
    }

    articlesData.forEach((_, index) => {
      const container = document.getElementById(`ai-container-${index}`);
      if(!container) return;

      container.classList.remove('hidden');
      
      const meta = getColumnMeta(colName);
      const cellId = `cell-${index}-${colName}`;
      const div = document.createElement('div');
      div.className = 'ai-cell fade-in';
      div.id = cellId;
      div.innerHTML = `
        <h5><i class="${meta.icon} ${meta.color}"></i> ${meta.title}</h5>
        <div class="text-slate-400 text-xs animate-pulse flex items-center gap-2">
          <i class="fas fa-circle-notch fa-spin"></i> En cola...
        </div>
      `;
      container.appendChild(div);
      
      taskQueue.push({ type: 'column', articleId: index, columnName: colName, cellId: cellId });
      totalTasks++;
    });

    processQueue();
  };

  function getColumnMeta(col) {
    const map = {
      'methodology': { title: 'Metodología', icon: 'fas fa-microscope', color: 'text-purple-500' },
      'population': { title: 'Población', icon: 'fas fa-users', color: 'text-orange-500' },
      'key_findings': { title: 'Hallazgos', icon: 'fas fa-lightbulb', color: 'text-yellow-500' },
      'limitations': { title: 'Limitaciones', icon: 'fas fa-exclamation-triangle', color: 'text-red-500' },
      'summary': { title: 'Resumen', icon: 'fas fa-align-left', color: 'text-blue-500' }
    };
    return map[col] || { title: col, icon: 'fas fa-robot', color: 'text-gray-500' };
  }

  // TRADUCCIÓN
  window.translateAllAbstracts = function() {
    const btn = document.getElementById('btn-translate-all');
    btn.classList.add('active');
    btn.innerHTML = '<i class="fas fa-spinner fa-spin text-blue-500 mr-2"></i> Procesando...';
    
    articlesData.forEach((art, idx) => {
      if(art.abstract && art.abstract.length > 20) {
        taskQueue.push({ type: 'translate', articleId: idx });
        totalTasks++;
      }
    });
    processQueue();
  };

  // PROCESADOR DE COLA
  async function processQueue() {
    if (isProcessing || taskQueue.length === 0) {
      updateQueueUI();
      return;
    }

    isProcessing = true;
    const task = taskQueue.shift();
    updateQueueUI("active");

    try {
      if (task.type === 'column') await fetchAIColumn(task);
      if (task.type === 'translate') await fetchTranslation(task);
    } catch (e) {
      console.error("Error en tarea:", e);
    }

    completedTasks++;
    setTimeout(() => {
      isProcessing = false;
      processQueue();
    }, 1500);
  }

  function updateQueueUI(state = "idle") {
    const dot = document.getElementById('agent-status-dot');
    const text = document.getElementById('queue-status');
    const bar = document.getElementById('queue-progress');
    
    if (taskQueue.length === 0 && !isProcessing) {
      dot.className = "w-2.5 h-2.5 rounded-full bg-slate-300";
      text.innerText = "Inactivo";
      bar.style.width = "100%";
      return;
    }

    dot.className = "w-2.5 h-2.5 rounded-full bg-emerald-500 animate-pulse";
    text.innerText = `Procesando (${taskQueue.length} pendientes)`;
    
    const percent = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;
    bar.style.width = `${percent}%`;
  }

  // LLAMADAS AJAX
  async function fetchAIColumn(task) {
    const cell = document.getElementById(task.cellId);
    if(!cell) return;
    
    cell.querySelector('div').innerHTML = `<i class="fas fa-brain text-indigo-500 animate-bounce"></i> Analizando...`;

    try {
      const response = await fetch('/generate_column', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          article: articlesData[task.articleId], 
          column_name: task.columnName 
        })
      });

      if(response.ok) {
        const data = await response.json();
        cell.querySelector('div').className = "text-slate-700 mt-1";
        cell.querySelector('div').innerHTML = data.value;
        
        if(!articlesData[task.articleId].ai_data) articlesData[task.articleId].ai_data = {};
        articlesData[task.articleId].ai_data[task.columnName] = data.value;
      }
    } catch(e) {
      cell.querySelector('div').innerHTML = `<span class="text-red-400">Error</span>`;
    }
  }

  async function fetchTranslation(task) {
    const box = document.getElementById(`translation-box-${task.articleId}`);
    if(!box) return;
    
    box.classList.remove('hidden');
    box.innerHTML = `<div class="mt-3 p-3 bg-blue-50 rounded-lg text-blue-500 text-xs">
      <i class="fas fa-spinner fa-spin"></i> Traduciendo...
    </div>`;

    try {
      const response = await fetch('/translate_abstract', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          article_id: task.articleId, 
          abstract: articlesData[task.articleId].abstract 
        })
      });

      if(response.ok) {
        const data = await response.json();
        box.className = "mt-3 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500";
        box.innerHTML = `<strong class="text-blue-700">[ES]</strong> <span class="text-slate-700">${data.translation}</span>`;
        articlesData[task.articleId].translation = data.translation;
      }
    } catch(e) { console.error(e); }
  }

  // DECISIONES
  window.setDecision = function(id, decision) {
    const card = document.getElementById(`card-${id}`);
    card.classList.remove('included', 'excluded');
    
    if (decision === 'included') {
      card.classList.add('included');
      decisions.add(id);
    } else {
      card.classList.add('excluded');
      decisions.delete(id);
    }
    document.getElementById('count-included').innerText = decisions.size;
  };

  // FINALIZAR
  window.submitScreening = async function() {
    if (decisions.size === 0) {
      if(!confirm("No has incluido ningún artículo. ¿Continuar?")) return;
    }
    
    const btn = document.querySelector('button[onclick="submitScreening()"]');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

    let payload = {
      sessionId: "{{ session_id }}",
      question: "{{ question }}",
      articles: {}
    };

    articlesData.forEach((art, idx) => {
      let status = 'pending';
      const card = document.getElementById(`card-${idx}`);
      if (card.classList.contains('included')) status = 'included';
      if (card.classList.contains('excluded')) status = 'excluded';

      payload.articles[idx] = {
        status: status,
        data: art,
        aiGeneratedFields: art.ai_data || {},
        translation: art.translation || ""
      };
    });

    try {
      const res = await fetch('/submit_screening', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      if(res.ok) {
        const html = await res.text();
        document.open(); document.write(html); document.close();
      }
    } catch(e) {
      alert("Error de conexión");
      btn.disabled = false;
    }
  };
</script>

</body>
</html>