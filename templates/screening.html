<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cribado Manual - PRISMA Assistant</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- ‚úÖ AGREGAR PUTER.JS - SIN RATE LIMITS -->
  <script src="https://js.puter.com/v2/"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    
    .gradient-hero {
      background: linear-gradient(135deg, #1e3a8a 0%, #5b21b6 50%, #059669 100%);
    }
    
    .app-layout { display: flex; height: 100vh; flex-direction: column; }
    .main-content { flex: 1; display: flex; overflow: hidden; }
    .table-area { flex: 1; overflow-y: auto; padding: 24px; }
    
    .sidebar {
      width: 320px;
      min-width: 320px;
      background: white;
      border-left: 1px solid #e2e8f0;
      padding: 20px;
      overflow-y: auto;
      box-shadow: -4px 0 20px rgba(0,0,0,0.05);
    }

    .paper-card {
      background: white;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      margin-bottom: 20px;
      transition: all 0.3s ease;
      overflow: hidden;
    }
    .paper-card:hover { box-shadow: 0 8px 20px rgba(0,0,0,0.08); transform: translateY(-2px); }

    .status-bar { width: 6px; background: #cbd5e1; }
    .paper-card.included .status-bar { background: #10b981; }
    .paper-card.excluded .status-bar { background: #ef4444; opacity: 0.5; }
    .paper-card.excluded { opacity: 0.6; background: #f8fafc; }

    .ai-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1px;
      background: #e2e8f0;
      border-top: 1px solid #e2e8f0;
    }
    
    /* ‚úÖ ARREGLO CR√çTICO: Permitir word-wrap en celdas de IA */
    .ai-cell {
      background: #f8fafc;
      padding: 16px;
      font-size: 0.9rem;
      line-height: 1.6;
      color: #334155;
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: normal;
    }
    
    .ai-cell h5 {
      font-size: 0.75rem;
      text-transform: uppercase;
      font-weight: 700;
      color: #64748b;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .col-btn {
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 8px;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: 600;
      color: #475569;
      background: #fff;
      border: 1px solid #e2e8f0;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
      display: flex;
      align-items: center;
    }
    .col-btn:hover { background: #f1f5f9; border-color: #cbd5e1; transform: translateX(2px); }
    .col-btn.active { background: #eff6ff; border-color: #3b82f6; color: #1d4ed8; }
    .col-btn i { width: 20px; margin-right: 10px; }

    .relevance-badge {
      font-size: 0.85rem;
      font-weight: 700;
      padding: 6px 12px;
      border-radius: 8px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .relevance-high { background: #d1fae5; color: #065f46; border: 2px solid #10b981; }
    .relevance-medium { background: #fef3c7; color: #92400e; border: 2px solid #f59e0b; }
    .relevance-low { background: #fee2e2; color: #991b1b; border: 2px solid #ef4444; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .fade-in { animation: fadeIn 0.4s ease-out; }
    
    .loading-indicator {
      text-align: center;
      padding: 40px;
      color: #64748b;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-indigo-50">

<div class="app-layout">
  
  <!-- HEADER -->
  <div class="gradient-hero px-8 py-5 flex justify-between items-center text-white shadow-xl">
    <div class="flex items-center gap-4">
      <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
        <i class="fas fa-user-check text-xl"></i>
      </div>
      <div>
        <h1 class="text-2xl font-bold leading-none">Cribado Manual de Art√≠culos</h1>
        <p class="text-sm text-emerald-100 mt-1"><span id="total-articles-count">{{ articles|length }}</span> art√≠culos candidatos (>= 70% relevancia)</p>
      </div>
    </div>
    
    <div class="flex items-center gap-4">
      <div class="bg-black/20 px-5 py-3 rounded-xl text-sm font-medium backdrop-blur-sm border border-white/10">
        <span class="text-emerald-300 font-bold text-2xl" id="count-included">0</span>
        <span class="text-white/70 ml-2">Incluidos</span>
      </div>
      <button onclick="submitScreening()" class="bg-white text-emerald-800 px-8 py-3 rounded-xl text-sm font-bold hover:bg-emerald-50 transition shadow-xl flex items-center gap-2">
        <i class="fas fa-arrow-right"></i> Finalizar Revisi√≥n
      </button>
    </div>
  </div>

  <div class="main-content">
    
    <!-- √ÅREA DE ART√çCULOS -->
    <div class="table-area">
      <div class="max-w-6xl mx-auto" id="articles-list">
        <div class="loading-indicator" id="loading-indicator">
          <i class="fas fa-spinner fa-spin text-4xl text-indigo-500 mb-4"></i>
          <p class="text-lg font-semibold">Cargando art√≠culos...</p>
        </div>
      </div>
    </div>

    <!-- SIDEBAR -->
    <div class="sidebar">
      
      <div class="mb-8">
        <h3 class="text-xs font-extrabold text-slate-400 uppercase tracking-wider mb-4">üöÄ Modo: Puter.js (Sin L√≠mites)</h3>
        <button onclick="translateAllAbstracts()" id="btn-translate-all" class="col-btn">
          <i class="fas fa-language text-blue-500"></i> Traducir Todos los Abstracts
        </button>
      </div>

      <div class="mb-8">
        <h3 class="text-xs font-extrabold text-slate-400 uppercase tracking-wider mb-4">Agregar Columnas IA</h3>
        
        <button onclick="addColumn('summary')" id="btn-summary" class="col-btn">
          <i class="fas fa-align-left text-blue-500"></i> Resumen (Espa√±ol)
        </button>
        <button onclick="addColumn('methodology')" id="btn-methodology" class="col-btn">
          <i class="fas fa-microscope text-purple-500"></i> Metodolog√≠a
        </button>
        <button onclick="addColumn('population')" id="btn-population" class="col-btn">
          <i class="fas fa-users text-orange-500"></i> Poblaci√≥n / Datasets
        </button>
        
        <button onclick="addColumn('study_design')" id="btn-study_design" class="col-btn">
          <i class="fas fa-project-diagram text-cyan-600"></i> Dise√±o del Estudio
        </button>
        <button onclick="addColumn('objectives')" id="btn-objectives" class="col-btn">
          <i class="fas fa-bullseye text-emerald-600"></i> Objetivos
        </button>
        <button onclick="addColumn('independent_variables')" id="btn-independent_variables" class="col-btn">
          <i class="fas fa-sliders-h text-indigo-500"></i> Variables Indep.
        </button>
        <button onclick="addColumn('dependent_variables')" id="btn-dependent_variables" class="col-btn">
          <i class="fas fa-chart-line text-pink-500"></i> Variables Dep.
        </button>

        <button onclick="addColumn('key_findings')" id="btn-key_findings" class="col-btn">
          <i class="fas fa-lightbulb text-yellow-500"></i> Hallazgos Clave
        </button>
        <button onclick="addColumn('limitations')" id="btn-limitations" class="col-btn">
          <i class="fas fa-exclamation-triangle text-red-500"></i> Limitaciones
        </button>
      </div>

      <div class="mt-auto bg-slate-50 p-4 rounded-xl border border-slate-100">
        <div class="flex items-center justify-between mb-2">
          <span class="text-xs font-bold text-slate-600">Puter.js IA</span>
          <div class="w-2.5 h-2.5 rounded-full bg-slate-300" id="agent-status-dot"></div>
        </div>
        <p class="text-xs text-slate-400 truncate" id="queue-status">Inactivo</p>
        <div class="w-full bg-slate-200 rounded-full h-1.5 mt-2">
          <div class="bg-emerald-500 h-full transition-all" style="width: 0%" id="queue-progress"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
  // ============================================================
  // üî• VARIABLES GLOBALES
  // ============================================================
  let articlesData = [];
  let activeColumns = [];
  let taskQueue = [];
  let isProcessing = false;
  let totalTasks = 0;
  let completedTasks = 0;
  let decisions = new Set();
  
  // ============================================================
  // üî• CARGA DE DATOS
  // ============================================================
  
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function loadArticles() {
    try {
      const rawData = {{ articles | tojson | safe }};
      
      if (!rawData || !Array.isArray(rawData)) {
        throw new Error("Datos no v√°lidos desde el servidor");
      }
      
      articlesData = rawData.filter(art => {
        return art && typeof art === 'object' && art.title && art.title.length >= 5;
      });
      
      console.log("‚úÖ Art√≠culos cargados:", articlesData.length);
      
      if (articlesData.length === 0) {
        throw new Error("No hay art√≠culos v√°lidos");
      }
      
      return true;
      
    } catch (e) {
      console.error("‚ùå Error cargando datos:", e);
      document.getElementById('articles-list').innerHTML = `
        <div class="bg-red-50 border-2 border-red-200 rounded-xl p-8 text-center">
          <i class="fas fa-exclamation-circle text-red-500 text-5xl mb-4"></i>
          <h2 class="text-xl font-bold text-red-700 mb-2">Error al Cargar Art√≠culos</h2>
          <p class="text-red-600 mb-4">${escapeHtml(e.message)}</p>
          <button onclick="location.reload()" class="bg-red-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-600">
            <i class="fas fa-redo mr-2"></i> Recargar P√°gina
          </button>
        </div>
      `;
      return false;
    }
  }

  // ============================================================
  // üé® RENDERIZADO DE ART√çCULOS
  // ============================================================
  function renderArticles() {
    const container = document.getElementById('articles-list');
    const loadingIndicator = document.getElementById('loading-indicator');
    
    if (!articlesData || articlesData.length === 0) {
      container.innerHTML = `
        <div class="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-8 text-center">
          <i class="fas fa-inbox text-yellow-500 text-5xl mb-4"></i>
          <h2 class="text-xl font-bold text-yellow-700">No hay art√≠culos para revisar</h2>
        </div>
      `;
      return;
    }
    
    if (loadingIndicator) loadingIndicator.remove();
    
    articlesData.forEach((article, index) => {
      const card = createArticleCard(article, index);
      container.appendChild(card);
    });
    
    console.log(`‚úÖ Renderizados ${articlesData.length} art√≠culos`);
  }

  function createArticleCard(article, index) {
    const card = document.createElement('div');
    card.className = 'paper-card flex fade-in';
    card.id = `card-${index}`;
    card.style.animationDelay = `${Math.min(index * 0.05, 2)}s`;
    
    const percent = Math.round((article.similarity || 0) * 100);
    let relevanceClass = 'relevance-low';
    let relevanceIcon = '‚ùå';
    if (percent >= 85) { 
      relevanceClass = 'relevance-high'; 
      relevanceIcon = '‚úÖ'; 
    } else if (percent >= 70) { 
      relevanceClass = 'relevance-medium'; 
      relevanceIcon = '‚ö†Ô∏è'; 
    }
    
    const title = escapeHtml(article.title || 'Sin t√≠tulo');
    const year = escapeHtml(String(article.year || 'N/D'));
    const authors = Array.isArray(article.authors) 
      ? article.authors.slice(0, 2).map(a => escapeHtml(a)).join(', ')
      : 'Autores no disponibles';
    const journal = article.journal ? escapeHtml(article.journal) : '';
    const abstract = escapeHtml(article.abstract || 'Abstract no disponible');
    
    card.innerHTML = `
      <div class="status-bar"></div>
      <div class="w-full">
        <div class="p-6">
          <div class="flex justify-between items-start gap-6">
            <div class="flex-1">
              <h3 class="text-xl font-bold text-slate-800 mb-3 leading-tight hover:text-indigo-600 transition cursor-pointer">
                ${title}
              </h3>
              <div class="flex flex-wrap gap-3 text-sm text-slate-500 mb-4">
                <span class="bg-slate-100 px-3 py-1 rounded-lg font-semibold text-slate-700">
                  <i class="fas fa-calendar mr-1"></i> ${year}
                </span>
                <span><i class="fas fa-users mr-1"></i> ${authors}</span>
                ${journal ? `<span class="italic text-xs">${journal}</span>` : ''}
                <span class="relevance-badge ${relevanceClass}">
                  ${relevanceIcon} ${percent}% Relevancia
                </span>
              </div>

              <details class="group">
                <summary class="text-sm text-indigo-600 cursor-pointer hover:underline font-semibold list-none flex items-center gap-2 w-fit select-none">
                  <i class="fas fa-chevron-right text-xs transition-transform group-open:rotate-90"></i>
                  Ver Abstract Original
                </summary>
                <div class="mt-3 text-slate-600 leading-relaxed text-sm pl-4 border-l-4 border-slate-200">
                  ${abstract}
                  <div id="translation-box-${index}" class="hidden"></div>
                </div>
              </details>
            </div>

            <div class="flex flex-col gap-3 min-w-[140px]">
              <button onclick="setDecision(${index}, 'included')" 
                      class="px-5 py-3 rounded-xl border-2 border-emerald-200 text-emerald-700 text-sm font-bold hover:bg-emerald-50 transition flex items-center justify-center gap-2 bg-white shadow-md hover:shadow-xl">
                <i class="fas fa-check"></i> Incluir
              </button>
              <button onclick="setDecision(${index}, 'excluded')" 
                      class="px-5 py-3 rounded-xl border-2 border-red-200 text-red-700 text-sm font-bold hover:bg-red-50 transition flex items-center justify-center gap-2 bg-white shadow-md hover:shadow-xl">
                <i class="fas fa-times"></i> Excluir
              </button>
            </div>
          </div>
        </div>
        <div id="ai-container-${index}" class="ai-container hidden"></div>
      </div>
    `;
    
    return card;
  }

  // ============================================================
  // üöÄ INICIALIZACI√ìN
  // ============================================================
  let activeColumns = [];
  let taskQueue = [];
  let isProcessing = false;
  let totalTasks = 0;
  let completedTasks = 0;
  let decisions = new Set();

  document.addEventListener('DOMContentLoaded', function() {
    console.log("üöÄ Inicializando con Puter.js...");
    const success = loadArticles();
    if (success) renderArticles();
  });

  // ============================================================
  // üìã PROMPTS PARA PUTER.JS
  // ============================================================
  function getSystemPromptForColumn(column, researchQuestion) {
    const base = `Eres un experto en revisiones sistem√°ticas de literatura cient√≠fica.

CONTEXTO: La revisi√≥n busca responder: "${researchQuestion}"

REGLAS ESTRICTAS:
1. SOLO reporta lo que est√° EXPL√çCITAMENTE en el texto
2. Si no encuentras info, responde "No especificado"
3. NO inventes, NO asumas
4. Responde SOLO en JSON v√°lido (sin \`\`\`json ni markdown)
`;

    const prompts = {
      "study_design": base + `
COLUMNA: Dise√±o del Estudio
Clasifica el tipo de investigaci√≥n.

TIPOS: Experimental, Comparativo, Simulaci√≥n, Caso de estudio, Revisi√≥n sistem√°tica

FORMATO JSON:
{
  "tipo": "Experimental / Comparativo / etc.",
  "justificacion": "Explicaci√≥n breve (m√°ximo 150 caracteres)"
}`,

      "methodology": base + `
COLUMNA: Metodolog√≠a
Extrae detalles t√©cnicos.

FORMATO JSON:
{
  "tipo_estudio": "Experimental / Simulaci√≥n / etc.",
  "algoritmos": ["Algoritmo1", "Algoritmo2"],
  "frameworks": ["Framework1", "Framework2"],
  "arquitectura": "Descripci√≥n breve",
  "validacion": "M√©todo de validaci√≥n"
}`,

      "population": base + `
COLUMNA: Poblaci√≥n/Datasets
Identifica fuentes de datos.

FORMATO JSON:
{
  "datasets": ["Dataset1", "Dataset2"],
  "tamano": "N muestras",
  "tipo_datos": "Tipo",
  "origen": "Real-world / Simulado"
}`,

      "objectives": base + `
COLUMNA: Objetivos
Lista objetivos con verbos de acci√≥n.

FORMATO JSON:
{
  "objetivos": ["Evaluar...", "Comparar...", "Proponer..."]
}`,

      "key_findings": base + `
COLUMNA: Hallazgos Clave
Resultados principales CON N√öMEROS.

FORMATO JSON:
{
  "hallazgos": [
    {"resultado": "Descripci√≥n con n√∫meros", "metrica": "Accuracy", "valor": "95.3%"}
  ]
}`,

      "limitations": base + `
COLUMNA: Limitaciones
Restricciones expl√≠citas.

FORMATO JSON:
{
  "limitaciones": ["Limitaci√≥n 1", "Limitaci√≥n 2"]
}`,

      "summary": base + `
COLUMNA: Resumen Ejecutivo
Sintetiza en 2-3 oraciones.

FORMATO JSON:
{
  "objetivo": "Objetivo principal",
  "enfoque": "M√©todo usado",
  "contribucion": "Aporte del estudio"
}`
    };

    return prompts[column] || base;
  }

  function getUserPromptForColumn(column, context, question) {
    return `PREGUNTA: ${question}

TEXTO DEL ART√çCULO:
${context.substring(0, 15000)}

---

TAREA: Extrae informaci√≥n para "${column}" en JSON v√°lido.
IMPORTANTE: NO uses markdown, NO uses \`\`\`json, SOLO JSON puro.`;
  }

  // ============================================================
  // üé® FORMATEO DE RESPUESTAS (CORREGIDO)
  // ============================================================
  function formatResponseForHTML(columnName, data) {
    if (!data || data.error) {
      return "<div class='text-gray-400 text-xs italic'>No especificado.</div>";
    }

    // ‚úÖ STUDY_DESIGN - ARREGLADO
    if (columnName === "study_design") {
      const tipo = data.tipo || "No especificado";
      const justif = data.justificacion || "";

      return `
        <div class='space-y-2'>
          <div class='font-semibold text-indigo-600 text-base'>${tipo}</div>
          <div class='text-slate-600 text-sm leading-relaxed' style='word-wrap: break-word; white-space: normal;'>
            ${justif}
          </div>
        </div>
      `;
    }

    // METHODOLOGY
    if (columnName === "methodology") {
      const tipo = data.tipo_estudio || "No especificado";
      const algos = data.algoritmos || [];
      const frameworks = data.frameworks || [];
      
      let html = `<div class='space-y-2 text-sm'>`;
      html += `<div><span class='font-semibold'>Tipo:</span> ${tipo}</div>`;
      
      if (algos.length > 0 && algos[0] !== "No especificado") {
        html += `<div><span class='font-semibold'>Algoritmos:</span> ${algos.join(', ')}</div>`;
      }
      
      if (frameworks.length > 0 && frameworks[0] !== "No especificado") {
        html += `<div><span class='font-semibold'>Frameworks:</span> ${frameworks.join(', ')}</div>`;
      }
      
      html += `</div>`;
      return html;
    }

    // POPULATION
    if (columnName === "population") {
      const datasets = data.datasets || [];
      const tam = data.tamano || "";
      
      if (datasets.length === 0 || datasets[0] === "No especificado") {
        return "<div class='text-gray-400 text-xs italic'>Datasets no especificados.</div>";
      }
      
      let html = `<div class='space-y-1 text-sm'>`;
      html += `<div><span class='font-semibold'>Datasets:</span> ${datasets.join(', ')}</div>`;
      if (tam) html += `<div><span class='font-semibold'>Tama√±o:</span> ${tam}</div>`;
      html += `</div>`;
      return html;
    }

    // KEY_FINDINGS
    if (columnName === "key_findings") {
      const hallazgos = data.hallazgos || [];
      
      if (hallazgos.length === 0) {
        return "<div class='text-gray-400 text-xs italic'>Resultados no especificados.</div>";
      }
      
      let html = "<div class='space-y-2 text-sm'>";
      hallazgos.forEach(h => {
        if (h.resultado) {
          html += `<div>‚Ä¢ ${h.resultado}</div>`;
        }
      });
      html += "</div>";
      return html;
    }

    // OBJECTIVES
    if (columnName === "objectives") {
      const objs = data.objetivos || [];
      
      if (objs.length === 0) {
        return "<div class='text-gray-400 text-xs italic'>Objetivos no especificados.</div>";
      }
      
      let html = "<ul class='text-sm space-y-1 list-disc list-inside'>";
      objs.forEach(obj => {
        html += `<li>${obj}</li>`;
      });
      html += "</ul>";
      return html;
    }

    // LIMITATIONS
    if (columnName === "limitations") {
      const lims = data.limitaciones || [];
      
      if (lims.length === 0 || lims[0] === "No especificado") {
        return "<div class='text-gray-400 text-xs italic'>No mencionadas.</div>";
      }
      
      let html = "<ul class='text-sm space-y-1 list-disc list-inside'>";
      lims.forEach(lim => {
        if (lim !== "No especificado") html += `<li>${lim}</li>`;
      });
      html += "</ul>";
      return html;
    }

    // SUMMARY
    if (columnName === "summary") {
      const obj = data.objetivo || "?";
      const enf = data.enfoque || "?";
      const con = data.contribucion || "?";
      
      if (obj === "?" || obj.includes("No especificado")) {
        return "<div class='text-gray-400 text-xs italic'>Informaci√≥n insuficiente.</div>";
      }
      
      return `
        <div class='space-y-2 text-sm'>
          <div><span class='font-semibold text-slate-600'>Objetivo:</span> ${obj}</div>
          <div><span class='font-semibold text-slate-600'>Enfoque:</span> ${enf}</div>
          <div><span class='font-semibold text-slate-600'>Contribuci√≥n:</span> ${con}</div>
        </div>
      `;
    }

    // FALLBACK
    return `<pre class='text-xs bg-slate-50 p-2 rounded overflow-auto' style='max-height: 200px; white-space: pre-wrap; word-wrap: break-word;'>${JSON.stringify(data, null, 2)}</pre>`;
  }

  // ============================================================
  // ‚ö° LLAMADA A PUTER.JS (SIN RATE LIMITS)
  // ============================================================
  async function fetchAIColumnWithPuter(task) {
    const cell = document.getElementById(task.cellId);
    if (!cell) return;
    
    cell.querySelector('div').innerHTML = `
      <div class="flex items-center gap-2 text-indigo-600">
        <i class="fas fa-circle-notch fa-spin"></i> Analizando con Puter.js...
      </div>`;

    try {
      const article = articlesData[task.articleId];
      const context = article.full_text || article.abstract || "";
      const question = "{{ question }}";
      
      const systemPrompt = getSystemPromptForColumn(task.columnName, question);
      const userPrompt = getUserPromptForColumn(task.columnName, context, question);
      
      // ‚úÖ LLAMAR A PUTER.JS
      const fullPrompt = `${systemPrompt}\n\n${userPrompt}`;
      
      const response = await puter.ai.chat(fullPrompt, { 
        model: "gpt-4o-mini",
        temperature: 0.05
      });

      // Limpiar respuesta
      let content = response.replace(/```json|```/g, "").trim();
      
      // Parsear JSON
      const data = JSON.parse(content);

      // Formatear para HTML
      const formattedHTML = formatResponseForHTML(task.columnName, data);
      
      const contentDiv = cell.querySelector('div');
      contentDiv.className = "text-slate-700 mt-2 text-sm leading-relaxed";
      contentDiv.innerHTML = formattedHTML;

      // Guardar en datos locales
      if (!articlesData[task.articleId].ai_data) {
        articlesData[task.articleId].ai_data = {};
      }
      articlesData[task.articleId].ai_data[task.columnName] = formattedHTML;

      console.log(`‚úÖ Columna '${task.columnName}' generada para art√≠culo ${task.articleId}`);

    } catch (e) {
      console.error("‚ùå Error con Puter.js:", e);
      cell.querySelector('div').innerHTML = `
        <div class="text-amber-600 text-xs bg-amber-50 p-2 rounded border border-amber-200">
          <i class="fas fa-exclamation-triangle"></i> Error: ${e.message}. Reintentando en 3s...
        </div>`;
      
      // Reintentar despu√©s de 3 segundos
      setTimeout(() => {
        if (cell.querySelector('div').innerText.includes("Reintentando")) {
          fetchAIColumnWithPuter(task);
        }
      }, 3000);
    }
  }

  // ============================================================
  // üåê TRADUCCI√ìN CON PUTER.JS
  // ============================================================
  async function fetchTranslationWithPuter(task) {
    const box = document.getElementById(`translation-box-${task.articleId}`);
    if (!box) return;
    
    box.classList.remove('hidden');
    box.innerHTML = `<div class="mt-3 p-3 bg-blue-50 rounded-lg text-blue-500 text-xs">
      <i class="fas fa-spinner fa-spin"></i> Traduciendo con Puter.js...
    </div>`;

    try {
      const abstract = articlesData[task.articleId].abstract || "";
      
      const prompt = `Eres un traductor acad√©mico especializado.

Traduce este abstract cient√≠fico al espa√±ol manteniendo t√©rminos t√©cnicos:

${abstract.substring(0, 2000)}

Responde SOLO con la traducci√≥n, sin explicaciones adicionales.`;

      const translation = await puter.ai.chat(prompt, { 
        model: "gpt-4o-mini",
        temperature: 0.1
      });

      box.className = "mt-3 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500";
      box.innerHTML = `<strong class="text-blue-700">[ES]</strong> <span class="text-slate-700">${escapeHtml(translation)}</span>`;
      articlesData[task.articleId].translation = translation;

      console.log(`‚úÖ Traducci√≥n completada para art√≠culo ${task.articleId}`);

    } catch (e) { 
      console.error("‚ùå Error traduciendo:", e);
      box.innerHTML = `<span class="text-red-400 text-xs">Error de traducci√≥n: ${e.message}</span>`;
    }
  }

  // ============================================================
  // üìä AGREGAR COLUMNA
  // ============================================================
  window.addColumn = function(colName) {
    if (activeColumns.includes(colName)) {
      console.log(`‚ö†Ô∏è Columna '${colName}' ya est√° activa`);
      return;
    }
    
    activeColumns.push(colName);

    const btn = document.getElementById(`btn-${colName}`);
    if (btn) {
      btn.classList.add('active');
      btn.onclick = null;
      btn.innerHTML += ' <i class="fas fa-check ml-auto"></i>';
    }

    articlesData.forEach((_, index) => {
      const container = document.getElementById(`ai-container-${index}`);
      if (!container) return;

      container.classList.remove('hidden');
      
      const meta = getColumnMeta(colName);
      const cellId = `cell-${index}-${colName}`;
      const div = document.createElement('div');
      div.className = 'ai-cell fade-in';
      div.id = cellId;
      div.innerHTML = `
        <h5><i class="${meta.icon} ${meta.color}"></i> ${meta.title}</h5>
        <div class="text-slate-400 text-xs animate-pulse flex items-center gap-2">
          <i class="fas fa-circle-notch fa-spin"></i> En cola...
        </div>
      `;
      container.appendChild(div);
      
      taskQueue.push({ type: 'column', articleId: index, columnName: colName, cellId: cellId });
      totalTasks++;
    });

    processQueue();
  };

  function getColumnMeta(col) {
    const map = {
      'methodology': { title: 'Metodolog√≠a', icon: 'fas fa-microscope', color: 'text-purple-500' },
      'population': { title: 'Poblaci√≥n', icon: 'fas fa-users', color: 'text-orange-500' },
      'key_findings': { title: 'Hallazgos', icon: 'fas fa-lightbulb', color: 'text-yellow-500' },
      'limitations': { title: 'Limitaciones', icon: 'fas fa-exclamation-triangle', color: 'text-red-500' },
      'summary': { title: 'Resumen', icon: 'fas fa-align-left', color: 'text-blue-500' },
      'study_design': { title: 'Dise√±o', icon: 'fas fa-project-diagram', color: 'text-cyan-600' },
      'objectives': { title: 'Objetivos', icon: 'fas fa-bullseye', color: 'text-emerald-600' },
      'independent_variables': { title: 'Vars. Indep.', icon: 'fas fa-sliders-h', color: 'text-indigo-500' },
      'dependent_variables': { title: 'Vars. Dep.', icon: 'fas fa-chart-line', color: 'text-pink-500' }
    };
    return map[col] || { title: col, icon: 'fas fa-robot', color: 'text-gray-500' };
  }

  // ============================================================
  // üåê TRADUCIR TODOS LOS ABSTRACTS
  // ============================================================
  window.translateAllAbstracts = function() {
    const btn = document.getElementById('btn-translate-all');
    btn.classList.add('active');
    btn.innerHTML = '<i class="fas fa-spinner fa-spin text-blue-500 mr-2"></i> Procesando...';
    
    articlesData.forEach((art, idx) => {
      if (art.abstract && art.abstract.length > 20) {
        taskQueue.push({ type: 'translate', articleId: idx });
        totalTasks++;
      }
    });
    processQueue();
  };

  // ============================================================
  // üîÑ PROCESADOR DE COLA
  // ============================================================
  async function processQueue() {
    if (isProcessing || taskQueue.length === 0) {
      updateQueueUI();
      return;
    }

    isProcessing = true;
    const task = taskQueue.shift();
    updateQueueUI("active");

    try {
      if (task.type === 'column') await fetchAIColumnWithPuter(task);
      if (task.type === 'translate') await fetchTranslationWithPuter(task);
    } catch (e) {
      console.error("‚ùå Error en tarea:", e);
    }

    completedTasks++;
    setTimeout(() => {
      isProcessing = false;
      processQueue();
    }, 500); // Sin rate limit, m√°s r√°pido
  }

  function updateQueueUI(state = "idle") {
    const dot = document.getElementById('agent-status-dot');
    const text = document.getElementById('queue-status');
    const bar = document.getElementById('queue-progress');
    
    if (taskQueue.length === 0 && !isProcessing) {
      dot.className = "w-2.5 h-2.5 rounded-full bg-slate-300";
      text.innerText = "Inactivo";
      bar.style.width = "100%";
      return;
    }

    dot.className = "w-2.5 h-2.5 rounded-full bg-emerald-500 animate-pulse";
    text.innerText = `Procesando (${taskQueue.length} pendientes)`;
    
    const percent = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;
    bar.style.width = `${percent}%`;
  }

  // ============================================================
  // üìå DECISIONES (INCLUIR/EXCLUIR)
  // ============================================================
  window.setDecision = function(id, decision) {
    const card = document.getElementById(`card-${id}`);
    if (!card) return;
    
    card.classList.remove('included', 'excluded');
    
    if (decision === 'included') {
      card.classList.add('included');
      decisions.add(id);
    } else {
      card.classList.add('excluded');
      decisions.delete(id);
    }
    document.getElementById('count-included').innerText = decisions.size;
  };

  // ============================================================
  // ‚úÖ FINALIZAR REVISI√ìN
  // ============================================================
  window.submitScreening = async function() {
    if (decisions.size === 0) {
      if (!confirm("No has incluido ning√∫n art√≠culo. ¬øContinuar de todas formas?")) return;
    }
    
    const btn = document.querySelector('button[onclick="submitScreening()"]');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando decisiones...';

    let payload = {
      sessionId: "{{ session_id }}",
      question: "{{ question }}",
      articles: {}
    };

    articlesData.forEach((art, idx) => {
      let status = 'pending';
      const card = document.getElementById(`card-${idx}`);
      if (card && card.classList.contains('included')) status = 'included';
      if (card && card.classList.contains('excluded')) status = 'excluded';

      payload.articles[idx] = {
        status: status,
        data: art,
        aiGeneratedFields: art.ai_data || {},
        translation: art.translation || ""
      };
    });

    try {
      const res = await fetch('/submit_screening', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      
      if (res.ok) {
        const html = await res.text();
        document.open(); 
        document.write(html); 
        document.close();
      } else {
        throw new Error(`Error del servidor: ${res.status}`);
      }
    } catch (e) {
      alert(`Error de conexi√≥n: ${e.message}`);
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-arrow-right"></i> Finalizar Revisi√≥n';
    }
  };
</script>

</body>
</html>