<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Filtros PRISMA - UPAO</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    
    .gradient-hero {
      background: linear-gradient(135deg, #1e3a8a 0%, #5b21b6 50%, #059669 100%);
      position: relative;
      overflow: hidden;
    }
    .gradient-hero::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.3), transparent 50%);
      pointer-events: none;
    }
    
    .filter-chip {
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .filter-chip:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .filter-chip.active {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      border-color: #10b981;
    }

    /* --- NUEVO: Estilo para filtros desactivados --- */
    .filter-chip.disabled {
      cursor: not-allowed;
      background-color: #f3f4f6; /* bg-gray-100 */
      border-color: #e5e7eb; /* border-gray-200 */
      color: #9ca3af; /* text-gray-400 */
      opacity: 0.7;
    }
    .filter-chip.disabled:hover {
      transform: none;
      box-shadow: none;
    }
    
    .stat-card {
      transition: all 0.3s ease;
    }
    .stat-card:hover {
      transform: scale(1.02);
    }
    
    .btn-glow {
      background: linear-gradient(135deg, #059669, #10b981);
      transition: all 0.4s ease;
    }
    .btn-glow:hover {
      transform: translateY(-3px);
      box-shadow: 0 20px 40px rgba(5, 150, 105, 0.4);
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-indigo-50 min-h-screen">

  <!-- Hero Simplificado -->
  <div class="gradient-hero py-12 relative">
    <div class="container mx-auto px-6 max-w-6xl text-center text-white">
      <h1 class="text-4xl font-bold mb-3">
        <i class="fas fa-filter mr-3"></i>
        Criterios de Inclusión/Exclusión
      </h1>
      <p class="text-xl text-white/90">
        Aplica filtros para refinar tu revisión sistemática
      </p>
    </div>
  </div>

  <div class="container mx-auto px-6 max-w-6xl -mt-8 relative z-10">
    
    <!-- Estadísticas Principales -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
      <div class="bg-white/90 backdrop-blur-md p-5 rounded-2xl shadow-xl stat-card border border-white/50">
        <div class="text-sm text-gray-600 mb-2 font-semibold">Artículos Encontrados</div>
        <div class="text-3xl font-bold text-indigo-600" id="total-articles">{{ total }}</div>
      </div>
      <div class="bg-white/90 backdrop-blur-md p-5 rounded-2xl shadow-xl stat-card border border-white/50">
        <div class="text-sm text-gray-600 mb-2 font-semibold">Después de Filtros</div>
        <div class="text-3xl font-bold text-emerald-600" id="filtered-count">{{ total }}</div>
      </div>
      <div class="bg-white/90 backdrop-blur-md p-5 rounded-2xl shadow-xl stat-card border border-white/50">
        <div class="text-sm text-gray-600 mb-2 font-semibold">Duplicados (est.)</div>
        <div class="text-3xl font-bold text-orange-600" id="duplicates-count">0</div>
      </div>
      <div class="bg-white/90 backdrop-blur-md p-5 rounded-2xl shadow-xl stat-card border border-white/50">
        <div class="text-sm text-gray-600 mb-2 font-semibold">Artículos Finales</div>
        <div class="text-3xl font-bold text-purple-600" id="final-count">{{ total }}</div>
      </div>
    </div>

    <!-- Formulario de Filtros -->
    <form action="/apply_filters" method="post" id="filter-form" class="space-y-6">
      <input type="hidden" name="session_id" value="{{ session_id }}">
      <input type="hidden" name="question" value="{{ question }}">
      
      <!-- Rango de Años -->
      <div class="bg-white/90 backdrop-blur-md rounded-2xl shadow-xl p-8 border border-white/50">
        <h3 class="text-xl font-bold mb-6 flex items-center gap-3 text-gray-800">
          <i class="fas fa-calendar-range text-emerald-600"></i>
          Rango de Años
        </h3>
        <div class="grid grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-semibold mb-2 text-gray-700">Año Inicio</label>
            <input type="number" name="start_year" id="start_year" 
                   value="{{ year_min }}" min="{{ year_min }}" max="{{ year_max }}"
                   class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-emerald-500 focus:ring-4 focus:ring-emerald-100 transition-all">
          </div>
          <div>
            <label class="block text-sm font-semibold mb-2 text-gray-700">Año Final</label>
            <input type="number" name="end_year" id="end_year"
                   value="{{ year_max }}" min="{{ year_min }}" max="{{ year_max }}"
                   class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-emerald-500 focus:ring-4 focus:ring-emerald-100 transition-all">
          </div>
        </div>
        <div class="mt-4 text-sm text-emerald-600 flex items-center gap-2">
          <i class="fas fa-info-circle"></i>
          Rango disponible: {{ year_min }} - {{ year_max }}
        </div>
      </div>

      <!-- Cuartiles -->
      <div class="bg-white/90 backdrop-blur-md rounded-2xl shadow-xl p-8 border border-white/50">
        <h3 class="text-xl font-bold mb-4 flex items-center gap-3 text-gray-800">
          <i class="fas fa-ranking-star text-emerald-600"></i>
          Cuartil de Revistas (Scimago/JCR)
        </h3>
        <div class="flex flex-wrap gap-3">
          <!-- --- MODIFICACIÓN: Añadir clase 'disabled' y 'title' --- -->
          {% for q in ['Q1', 'Q2', 'Q3', 'Q4'] %}
          <label class="filter-chip px-6 py-3 border-2 border-gray-300 rounded-xl font-semibold flex items-center gap-2 disabled"
                 title="Filtro desactivado: Los metadatos de cuartil (Q1, Q2...) no son proporcionados por las APIs de búsqueda.">
            <input type="checkbox" name="quartiles" value="{{ q }}" class="hidden quartile-checkbox" disabled> <!-- Añadir 'disabled' al input -->
            <i class="fas fa-medal text-yellow-500"></i>
            {{ q }}
          </label>
          {% endfor %}
        </div>
        <!-- --- MODIFICACIÓN: Añadir nota de desactivación --- -->
        <p class="text-sm text-gray-600 mt-4 flex items-center gap-2">
          <i class="fas fa-info-circle text-orange-500"></i>
          Nota: El filtrado por cuartiles está desactivado. Las APIs no proporcionan esta información.
        </p>
      </div>

      <!-- Open Access -->
      <div class="bg-white/90 backdrop-blur-md rounded-2xl shadow-xl p-8 border border-white/50">
        <h3 class="text-xl font-bold mb-4 flex items-center gap-3 text-gray-800">
          <i class="fas fa-lock-open text-emerald-600"></i>
          Acceso Abierto
        </h3>
        <label class="filter-chip px-6 py-3 border-2 border-gray-300 rounded-xl font-semibold inline-flex items-center gap-3 bg-white hover:bg-gray-50">
          <input type="checkbox" name="open_access" value="true" class="hidden" id="open-access-checkbox">
          <i class="fas fa-check-circle text-emerald-600"></i>
          Solo artículos de acceso abierto
        </label>
      </div>

      <!-- Idiomas -->
      <div class="bg-white/90 backdrop-blur-md rounded-2xl shadow-xl p-8 border border-white/50">
        <h3 class="text-xl font-bold mb-4 flex items-center gap-3 text-gray-800">
          <i class="fas fa-language text-emerald-600"></i>
          Idiomas Detectados
        </h3>
        <div class="flex flex-wrap gap-3">
          {% for lang in languages %}
            <!-- --- MODIFICACIÓN: Solo mostrar idiomas que tienen artículos --- -->
            {% if lang.count > 0 %}
            <label class="filter-chip px-6 py-3 border-2 border-gray-300 rounded-xl font-semibold bg-white hover:bg-gray-50">
              <input type="checkbox" name="languages" value="{{ lang.code }}" class="hidden language-checkbox">
              <span class="text-2xl mr-2">{{ lang.flag }}</span>
              {{ lang.name }} ({{ lang.count }})
            </label>
            {% endif %}
          {% endfor %}
        </div>
      </div>

      <!-- Top Journals -->
      <!-- --- MODIFICACIÓN: Cambiar de Top 20 a Todas las revistas --- -->
      <div class="bg-white/90 backdrop-blur-md rounded-2xl shadow-xl p-8 border border-white/50">
        <h3 class="text-xl font-bold mb-4 flex items-center gap-3 text-gray-800">
          <i class="fas fa-book text-emerald-600"></i>
          Revistas Encontradas ({{ all_journals | length }})
        </h3>
        <div class="space-y-2 max-h-72 overflow-y-auto pr-2">
          <!-- Iterar sobre 'all_journals' en lugar de 'top_journals' -->
          {% for journal in all_journals %}
          <label class="filter-chip px-4 py-3 border-2 border-gray-300 rounded-xl flex items-center justify-between bg-white hover:bg-gray-50">
            <span class="font-medium text-gray-800">{{ journal.name }}</span>
            <div class="flex items-center gap-3">
              <span class="text-sm text-gray-600 bg-gray-100 px-3 py-1 rounded-full">({{ journal.count }} arts.)</span>
              <input type="checkbox" name="journals" value="{{ journal.name }}" class="w-5 h-5 text-emerald-600 rounded focus:ring-emerald-200">
            </div>
          </label>
          {% endfor %}
        </div>
      </div>

      <!-- Botón de Acción Principal -->
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-emerald-500 p-6 rounded-r-xl mb-6">
        <div class="flex items-start gap-4">
          <i class="fas fa-info-circle text-emerald-600 text-2xl mt-1"></i>
          <div>
            <p class="font-bold text-gray-800 mb-2">Próximos Pasos:</p>
            <p class="text-sm text-gray-700">
              Al continuar, se aplicarán los filtros, se eliminarán duplicados, se realizará el cribado semántico 
              y se generará la síntesis con IA. Tiempo estimado: <strong>2-4 minutos</strong>.
            </p>
          </div>
        </div>
      </div>

      <button type="submit" id="submit-btn"
              class="w-full btn-glow text-white py-5 px-8 rounded-2xl font-bold text-xl shadow-xl transform transition-all duration-300 flex items-center justify-center gap-4 group">
        <i class="fas fa-arrow-right text-2xl group-hover:translate-x-2 transition-transform"></i>
        <span>Continuar con Análisis (<span id="btn-count">{{ total }}</span> artículos)</span>
      </button>

      <p class="text-center text-sm text-gray-500 mt-4 flex items-center justify-center gap-2">
        <i class="fas fa-download text-emerald-600"></i>
        <!-- MODIFICACIÓN: Enlace de descarga eliminado, se añadirá en la página de resultados -->
        <a href="#" id="download-link-placeholder" class="text-gray-500 hover:text-gray-700 font-semibold">
          (La descarga estará disponible después del análisis)
        </a>
      </p>
    </form>
  </div>

  <!-- Footer Simplificado -->
  <footer class="bg-gradient-to-r from-gray-900 to-gray-800 text-white py-8 mt-20">
    <div class="container mx-auto px-6 text-center">
      <p class="text-lg font-semibold">
        © 2025 <span class="text-emerald-400">Universidad Privada Antenor Orrego</span>
      </p>
    </div>
  </footer>

  <script>
    // --- INICIO DE LA CORRECCIÓN DEL BUG ---

    // Función unificada para actualizar todo
    function handleFilterChange() {
        // 1. Sincronizar la UI (clase 'active') con el estado REAL del checkbox
        document.querySelectorAll('.filter-chip').forEach(chip => {
            const checkbox = chip.querySelector('input[type="checkbox"]');
            if (checkbox && !checkbox.disabled) { // <-- No aplicar 'active' a chips desactivados
                chip.classList.toggle('active', checkbox.checked);
            }
        });
        
        // 2. Llamar a la función que actualiza los contadores vía AJAX
        updateFilterCount();
    }

    // 1. Escuchar el evento 'change' en todos los checkboxes dentro de los chips
    document.querySelectorAll('.filter-chip input[type="checkbox"]').forEach(checkbox => {
        // No añadir listener a los checkboxes desactivados (como los de cuartiles)
        if (!checkbox.disabled) {
            checkbox.addEventListener('change', handleFilterChange);
        }
    });

    // 2. Escuchar el evento 'change' en los inputs de año
    document.getElementById('start_year').addEventListener('change', handleFilterChange);
    document.getElementById('end_year').addEventListener('change', handleFilterChange);
   
    // --- FIN DE LA CORRECCIÓN DEL BUG ---


    // Actualizar contadores en tiempo real (AJAX REAL)
    // Esta función ahora es llamada por handleFilterChange()
    async function updateFilterCount() {
      // Obtener valores del formulario
      const formEl = document.getElementById('filter-form');
      const formData = new FormData(formEl);
      
      // Convertir checkboxes múltiples a strings separados por comas
      const journalsChecked = Array.from(formEl.querySelectorAll('input[name="journals"]:checked'))
        .map(cb => cb.value).join(',');
      const langsChecked = Array.from(formEl.querySelectorAll('input[name="languages"]:checked'))
        .map(cb => cb.value).join(',');
      const quartilesChecked = Array.from(formEl.querySelectorAll('input[name="quartiles"]:checked'))
        .map(cb => cb.value).join(',');
      
      // Crear FormData con formato correcto
      const data = new FormData();
      data.append('session_id', formData.get('session_id'));
      data.append('start_year', formData.get('start_year') || '');
      data.append('end_year', formData.get('end_year') || '');
      data.append('journals', journalsChecked);
      data.append('languages', langsChecked);
      data.append('quartiles', quartilesChecked);
      data.append('open_access', document.getElementById('open-access-checkbox').checked ? 'true' : 'false');
      
      // Mostrar loading
      document.getElementById('filtered-count').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      
      try {
        const response = await fetch('/update_filter_count', {
          method: 'POST',
          body: data,
        });
        
        if (response.ok) {
          const result = await response.json();
          
          // Actualizar con datos REALES del servidor
          document.getElementById('filtered-count').textContent = result.filtered_count;
          document.getElementById('duplicates-count').textContent = result.duplicates_count;
          document.getElementById('final-count').textContent = result.final_count;
          document.getElementById('btn-count').textContent = result.final_count;
          
          console.log('✅ Contadores actualizados:', result);
        } else {
          console.error('❌ Error del servidor:', response.status);
          const errorText = await response.text();
          console.error('Detalle:', errorText);
          document.getElementById('filtered-count').textContent = '{{ total }}';
        }
      } catch (error) {
        console.error('❌ Error AJAX:', error);
        document.getElementById('filtered-count').textContent = '{{ total }}';
      }
    }

    // Loading al enviar
    document.getElementById('filter-form').addEventListener('submit', function() {
      const btn = document.getElementById('submit-btn');
      btn.innerHTML = '<i class="fas fa-spinner fa-spin text-2xl"></i> Procesando artículos...';
      btn.disabled = true;
    });

    // Pequeña corrección: enlace de descarga en filters.html no tiene sentido, 
    // lo cambiamos a la página de resultados.
    const downloadLink = document.getElementById('download-link-placeholder');
    if (downloadLink) {
        downloadLink.addEventListener('click', (e) => {
            e.preventDefault();
            // Podríamos mostrar un mensaje, pero por ahora solo prevenimos el click
        });
    }

  </script>

</body>
</html>